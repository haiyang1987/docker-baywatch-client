input {
file {
  type => "namenode-metrics"
    start_position => "beginning"
    path => [ "/amb/log/hadoop-yarn/metrics/namenode-metrics.out" ]
  }
}
filter {
  if [type] == "namenode-metrics" {
    grok {
      patterns_dir => "/etc/logstash/conf.d/patterns"
      match => [
				"message", "%{WORD:time} %{JAVACLASS:yarnClass}: %{CONTEXT}, %{PROCESSNAME}, %{SESSIONID}, %{HOSTNAME}, %{MEMNONHEAPUSEDM}, %{MEMNONHEAPCOMMITTEDM}, %{MEMNONHEAPMAXM}, %{MEMHEAPUSEDM}, %{MEMHEAPCOMMITTEDM}, %{MEMHEAPMAXM}, %{MEMMAXM}, %{GCCOUNTPARNEW}, %{GCTIMEMILLISPARNEW}, %{GCCOUNTCONCURRENTMARKSWEEP}, %{GCTIMEMILLISCONCURRENTMARKSWEEP}, %{GCCOUNT}, %{GCTIMEMILLIS}, %{THREADSNEW}, %{THREADSRUNNABLE}, %{THREADSBLOCKED}, %{THREADSWAITING}, %{THREADSTIMEDWAITING}, %{THREADSTERMINATED}, %{LOGFATAL}, %{LOGERROR}, %{LOGWARN}, %{LOGINFO}",
				"message", "%{WORD:time} %{JAVACLASS:yarnClass}: %{CONTEXT}, %{HOSTNAME}, %{CACHEHIT}, %{CACHECLEARED}, %{CACHEUPDATED}",
				"message", "%{WORD:time} %{JAVACLASS:yarnClass}: %{CONTEXT}, %{HOSTNAME}, %{NUMACTIVESOURCES}, %{NUMALLSOURCES}, %{NUMACTIVESINKS}, %{NUMALLSINKS}, %{SINK_LOGSTASHNUMOPS}, %{SINK_LOGSTASHAVGTIME}, %{SINK_LOGSTASHDROPPED}, %{SINK_LOGSTASHQSIZE}, %{SNAPSHOTNUMOPS}, %{SNAPSHOTAVGTIME}, %{PUBLISHNUMOPS}, %{PUBLISHAVGTIME}, %{DROPPEDPUBALL}",
				"message", "%{WORD:time} %{JAVACLASS:yarnClass}: %{PORT}, %{CONTEXT}, %{HOSTNAME}, %{VERSIONREQUESTNUMOPS}, %{VERSIONREQUESTAVGTIME}, %{REGISTERDATANODENUMOPS}, %{REGISTERDATANODEAVGTIME}, %{SENDHEARTBEATNUMOPS}, %{SENDHEARTBEATAVGTIME}, %{SETSAFEMODENUMOPS}, %{SETSAFEMODEAVGTIME}, %{GETFILEINFONUMOPS}, %{GETFILEINFOAVGTIME}, %{MKDIRSNUMOPS}, %{MKDIRSAVGTIME}, %{SETPERMISSIONNUMOPS}, %{SETPERMISSIONAVGTIME}, %{SETOWNERNUMOPS}, %{SETOWNERAVGTIME}, %{BLOCKREPORTNUMOPS}, %{BLOCKREPORTAVGTIME}, %{GETLISTINGNUMOPS}, %{GETLISTINGAVGTIME}, %{GETTRANSACTIONIDNUMOPS}, %{GETTRANSACTIONIDAVGTIME}, %{ROLLEDITLOGNUMOPS}, %{ROLLEDITLOGAVGTIME}, %{GETEDITLOGMANIFESTNUMOPS}, %{GETEDITLOGMANIFESTAVGTIME}, %{CREATENUMOPS}, %{CREATEAVGTIME}, %{ADDBLOCKNUMOPS}, %{ADDBLOCKAVGTIME}, %{GETSERVERDEFAULTSNUMOPS}, %{GETSERVERDEFAULTSAVGTIME}, %{BLOCKRECEIVEDANDDELETEDNUMOPS}, %{BLOCKRECEIVEDANDDELETEDAVGTIME}, %{COMPLETENUMOPS}, %{COMPLETEAVGTIME}, %{SETREPLICATIONNUMOPS}, %{SETREPLICATIONAVGTIME}, %{GETBLOCKLOCATIONSNUMOPS}, %{GETBLOCKLOCATIONSAVGTIME}, %{FSYNCNUMOPS}, %{FSYNCAVGTIME}, %{RENEWLEASENUMOPS}, %{RENEWLEASEAVGTIME}, %{RENAMENUMOPS}, %{RENAMEAVGTIME}, %{DELETENUMOPS}, %{DELETEAVGTIME}, %{RENAME2NUMOPS}, %{RENAME2AVGTIME}",
				"message", "%{WORD:time} %{JAVACLASS:yarnClass}: %{HOSTNAME}, %{ELAPSEDTIME}, %{PERCENTCOMPLETE}, %{LOADINGFSIMAGECOUNT}, %{LOADINGFSIMAGEELAPSEDTIME}, %{LOADINGFSIMAGETOTAL}, %{LOADINGFSIMAGEPERCENTCOMPLETE}, %{LOADINGEDITSCOUNT}, %{LOADINGEDITSELAPSEDTIME}, %{LOADINGEDITSTOTAL}, %{LOADINGEDITSPERCENTCOMPLETE}, %{SAVINGCHECKPOINTCOUNT}, %{SAVINGCHECKPOINTELAPSEDTIME}, %{SAVINGCHECKPOINTTOTAL}, %{SAVINGCHECKPOINTPERCENTCOMPLETE}, %{SAFEMODECOUNT}, %{SAFEMODEELAPSEDTIME}, %{SAFEMODETOTAL}, %{SAFEMODEPERCENTCOMPLETE}",
				"message", "%{WORD:time} %{JAVACLASS:yarnClass}: %{CONTEXT}, %{HOSTNAME}, %{LOGINSUCCESSNUMOPS}, %{LOGINSUCCESSAVGTIME}, %{LOGINFAILURENUMOPS}, %{LOGINFAILUREAVGTIME}, %{GETGROUPSNUMOPS}, %{GETGROUPSAVGTIME}",
				"message", "%{WORD:time} %{JAVACLASS:yarnClass}: %{CONTEXT}, %{HASTATE}, %{HOSTNAME}, %{MISSINGBLOCKS}, %{EXPIREDHEARTBEATS}, %{TRANSACTIONSSINCELASTCHECKPOINT}, %{TRANSACTIONSSINCELASTLOGROLL}, %{LASTWRITTENTRANSACTIONID}, %{LASTCHECKPOINTTIME}, %{CAPACITYTOTAL}, %{CAPACITYTOTALGB}, %{CAPACITYUSED}, %{CAPACITYUSEDGB}, %{CAPACITYREMAINING}, %{CAPACITYREMAININGGB}, %{CAPACITYUSEDNONDFS}, %{TOTALLOAD}, %{SNAPSHOTTABLEDIRECTORIES}, %{SNAPSHOTS}, %{BLOCKSTOTAL}, %{FILESTOTAL}, %{PENDINGREPLICATIONBLOCKS}, %{UNDERREPLICATEDBLOCKS}, %{CORRUPTBLOCKS}, %{SCHEDULEDREPLICATIONBLOCKS}, %{PENDINGDELETIONBLOCKS}, %{EXCESSBLOCKS}, %{POSTPONEDMISREPLICATEDBLOCKS}, %{PENDINGDATANODEMESSAGECOUNT}, %{MILLISSINCELASTLOADEDEDITS}, %{BLOCKCAPACITY}, %{STALEDATANODES}, %{TOTALFILES}",
				"message", "%{WORD:time} %{JAVACLASS:yarnClass}: %{PROCESSNAME}, %{SESSIONID}, %{CONTEXT}, %{HOSTNAME}, %{CREATEFILEOPS}, %{FILESCREATED}, %{FILESAPPENDED}, %{GETBLOCKLOCATIONS}, %{FILESRENAMED}, %{GETLISTINGOPS}, %{DELETEFILEOPS}, %{FILESDELETED}, %{FILEINFOOPS}, %{ADDBLOCKOPS}, %{GETADDITIONALDATANODEOPS}, %{CREATESYMLINKOPS}, %{GETLINKTARGETOPS}, %{FILESINGETLISTINGOPS}, %{ALLOWSNAPSHOTOPS}, %{DISALLOWSNAPSHOTOPS}, %{CREATESNAPSHOTOPS}, %{DELETESNAPSHOTOPS}, %{RENAMESNAPSHOTOPS}, %{LISTSNAPSHOTTABLEDIROPS}, %{SNAPSHOTDIFFREPORTOPS}, %{BLOCKRECEIVEDANDDELETEDOPS}, %{STORAGEBLOCKREPORTOPS}, %{TRANSACTIONSNUMOPS}, %{TRANSACTIONSAVGTIME}, %{SYNCSNUMOPS}, %{SYNCSAVGTIME}, %{TRANSACTIONSBATCHEDINSYNC}, %{BLOCKREPORTNUMOPS}, %{BLOCKREPORTAVGTIME}, %{CACHEREPORTNUMOPS}, %{CACHEREPORTAVGTIME}, %{SAFEMODETIME}, %{FSIMAGELOADTIME}, %{GETEDITNUMOPS}, %{GETEDITAVGTIME}, %{GETIMAGENUMOPS}, %{GETIMAGEAVGTIME}, %{PUTIMAGENUMOPS}, %{PUTIMAGEAVGTIME}",
				"message", "%{WORD:time} %{JAVACLASS:yarnClass}: %{PORT}, %{CONTEXT}, %{HOSTNAME}, %{RECEIVEDBYTES}, %{SENTBYTES}, %{RPCQUEUETIMENUMOPS}, %{RPCQUEUETIMEAVGTIME}, %{RPCPROCESSINGTIMENUMOPS}, %{RPCPROCESSINGTIMEAVGTIME}, %{RPCAUTHENTICATIONFAILURES}, %{RPCAUTHENTICATIONSUCCESSES}, %{RPCAUTHORIZATIONFAILURES}, %{RPCAUTHORIZATIONSUCCESSES}, %{NUMOPENCONNECTIONS}, %{CALLQUEUELENGTH}"
			]
    }
    ruby {
      code => '
          require "time"
          event["heatmap"] = Time.parse(event["@timestamp"].to_s).strftime "%u-" + (Time.parse(event["@timestamp"].to_s).strftime "%a") + (Time.parse(event["@timestamp"].to_s).strftime ":%H-") + ((Time.parse(event["@timestamp"].to_s) + 60*60).strftime "%H");
		'
		}
	mutate {
		convert => [
			"DroppedPubAll", "integer",
			"AddBlockNumOps", "integer",
			"LoginSuccessNumOps", "integer",
			"BlockReportNumOps", "integer",
			"SafeModeTotal", "integer",
			"ThreadsTimedWaiting", "integer",
			"CreateSymlinkOps", "integer",
			"ThreadsTerminated", "integer",
			"NumActiveSources", "integer",
			"CapacityUsedNonDFS", "integer",
			"FilesInGetListingOps", "integer",
			"NumActiveSinks", "integer",
			"GetBlockLocationsNumOps", "integer",
			"PublishNumOps", "integer",
			"PendingDeletionBlocks", "integer",
			"CacheReportNumOps", "integer",
			"ScheduledReplicationBlocks", "integer",
			"BlockReceivedAndDeletedNumOps", "integer",
			"GcTimeMillisParNew", "integer",
			"CapacityTotal", "integer",
			"ExcessBlocks", "integer",
			"DeleteFileOps", "integer",
			"GetListingNumOps", "integer",
			"SavingCheckpointTotal", "integer",
			"GetServerDefaultsNumOps", "integer",
			"RpcAuthorizationFailures", "integer",
			"SetSafeModeNumOps", "integer",
			"CompleteNumOps", "integer",
			"ThreadsWaiting", "integer",
			"Sink_logstashNumOps", "integer",
			"CapacityRemaining", "integer",
			"PostponedMisreplicatedBlocks", "integer",
			"MillisSinceLastLoadedEdits", "integer",
			"LogInfo", "integer",
			"RenewLeaseNumOps", "integer",
			"GetEditLogManifestNumOps", "integer",
			"FilesAppended", "integer",
			"MkdirsNumOps", "integer",
			"CreateFileOps", "integer",
			"GetAdditionalDatanodeOps", "integer",
			"CacheCleared", "integer",
			"StaleDataNodes", "integer",
			"FilesRenamed", "integer",
			"TotalFiles", "integer",
			"FsyncNumOps", "integer",
			"FilesTotal", "integer",
			"CreateNumOps", "integer",
			"LoadingEditsElapsedTime", "integer",
			"PendingReplicationBlocks", "integer",
			"LoadingFsImageElapsedTime", "integer",
			"SetOwnerNumOps", "integer",
			"GetTransactionIdNumOps", "integer",
			"LastCheckpointTime", "integer",
			"TransactionsBatchedInSync", "integer",
			"GetGroupsNumOps", "integer",
			"ElapsedTime", "integer",
			"DisallowSnapshotOps", "integer",
			"GetImageNumOps", "integer",
			"SavingCheckpointElapsedTime", "integer",
			"RpcAuthorizationSuccesses", "integer",
			"CapacityUsed", "integer",
			"FileInfoOps", "integer",
			"SafeModeElapsedTime", "integer",
			"PutImageNumOps", "integer",
			"LoadingEditsTotal", "integer",
			"FilesCreated", "integer",
			"NumAllSinks", "integer",
			"LoginFailureNumOps", "integer",
			"MissingBlocks", "integer",
			"SnapshottableDirectories", "integer",
			"CorruptBlocks", "integer",
			"SetPermissionNumOps", "integer",
			"GcTimeMillis", "integer",
			"PendingDataNodeMessageCount", "integer",
			"RpcAuthenticationSuccesses", "integer",
			"SnapshotDiffReportOps", "integer",
			"ThreadsBlocked", "integer",
			"GetListingOps", "integer",
			"RpcAuthenticationFailures", "integer",
			"GetEditNumOps", "integer",
			"GcTimeMillisConcurrentMarkSweep", "integer",
			"AddBlockOps", "integer",
			"SafeModeTime", "integer",
			"BlockReceivedAndDeletedOps", "integer",
			"GcCountParNew", "integer",
			"LoadingFsImageCount", "integer",
			"BlocksTotal", "integer",
			"GetBlockLocations", "integer",
			"RegisterDatanodeNumOps", "integer",
			"SafeModeCount", "integer",
			"GcCountConcurrentMarkSweep", "integer",
			"NumAllSources", "integer",
			"ExpiredHeartbeats", "integer",
			"NumOpenConnections", "integer",
			"GcCount", "integer",
			"DeleteSnapshotOps", "integer",
			"SyncsNumOps", "integer",
			"LoadingEditsCount", "integer",
			"TransactionsSinceLastCheckpoint", "integer",
			"RenameSnapshotOps", "integer",
			"RpcProcessingTimeNumOps", "integer",
			"Snapshots", "integer",
			"RpcQueueTimeNumOps", "integer",
			"ReceivedBytes", "integer",
			"CallQueueLength", "integer",
			"TotalLoad", "integer",
			"LogFatal", "integer",
			"GetFileInfoNumOps", "integer",
			"RollEditLogNumOps", "integer",
			"VersionRequestNumOps", "integer",
			"RenameNumOps", "integer",
			"TransactionsNumOps", "integer",
			"StorageBlockReportOps", "integer",
			"SetReplicationNumOps", "integer",
			"DeleteNumOps", "integer",
			"SentBytes", "integer",
			"Sink_logstashQsize", "integer",
			"SavingCheckpointCount", "integer",
			"GetLinkTargetOps", "integer",
			"TransactionsSinceLastLogRoll", "integer",
			"CacheUpdated", "integer",
			"port", "integer",
			"UnderReplicatedBlocks", "integer",
			"FsImageLoadTime", "integer",
			"FilesDeleted", "integer",
			"LogWarn", "integer",
			"BlockCapacity", "integer",
			"LogError", "integer",
			"AllowSnapshotOps", "integer",
			"ListSnapshottableDirOps", "integer",
			"CacheHit", "integer",
			"Rename2NumOps", "integer",
			"ThreadsNew", "integer",
			"SnapshotNumOps", "integer",
			"ThreadsRunnable", "integer",
			"CreateSnapshotOps", "integer",
			"LoadingFsImageTotal", "integer",
			"SendHeartbeatNumOps", "integer",
			"Sink_logstashDropped", "integer",
			"LastWrittenTransactionId", "integer"		]
		}
	}
}
